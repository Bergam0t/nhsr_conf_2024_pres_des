---
title: "Unleashing the Power of Pathway Simulation"
author:
    name: Sammi Rosser
    affiliation: Health Service Modelling Associates Programme
format:
  revealjs:
    output-file: index.html
    view-distance: 100
    height: 800
    width: 1250
    transition: slide
    plotly-connected: true
    background-transition: fade
    theme: [default, custom.scss]
    title-slide-attributes:
        data-background-image: /resources/banner.png
    include-in-header:
      - text: |
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><link href='https://fonts.googleapis.com/css?family=Lexend' rel='stylesheet'>

---

## About Me

```{python}
#| output: false
import plotly
import plotly.io as pio
pio.renderers.default = "plotly_mimetype+notebook_connected"
```

:::: {.columns}

::: {.column width="40%"}
![](resources/profile.jpg)
:::

::: {.column width="60%"}
- Former NHS Analyst/Data Scientist
- MSc Health Data Science @ Exeter
- Now a HSMA trainer
- Mainly a Pythonista these days<br/>(but I ‚ù§Ô∏è R too)
- Obsessed with Quarto, Streamlit, Simulation, Maps & Dataviz
:::

[{{< fa brands linkedin >}} Add Me On LinkedIn](https://www.linkedin.com/in/sammijaderosser/)

[{{< fa brands github >}} Follow Me On GitHub](https://github.com/Bergam0t)

::::

## About HSMA {.center}

:::: {.columns}

::: {.column width="40%"}
![](resources/hsma_logo.png)
:::

::: {.column width="10%"}
:::

::: {.column width="50%" }


```{=html}
</br>
```
::: {.r-fit-text}
The Health Service Modelling Associates is a 15 month data science and operational research training and mentoring programme.

Supported by the NIHR PenARC and the NHS Digital Academy, the full programme is provided **free of charge** to people working in health, social care and policing and is accredited by AphA.
```{=html}
</br>
```
![](resources/nihr_logo.png)
:::

:::

::::

[{{< fa globe >}} Visit Our Website for Free Training](https://hsma-programme.github.io/hsma_site/)

[{{< fa brands youtube >}} Subscribe to our YouTube Channel](https://www.youtube.com/@hsma)

[{{< fa brands github >}} Follow us on GitHub](https://github.com/hsma-programme)

# Part 1: Pathways

## Queue, Queue, Barney McGrew

Healthcare tends to be **full** of queueing problems.

::: {.incremental}
- People attending a walk-in clinic or emergency department
- People calling a telephone-based service like 111 or a mental health crisis line
- People on a cancer diagnosis and treatment pathway
- People waiting to be assessed for ADHD and Autism, or on the waiting list for a gender clinic
- People waiting for a series of treatment with a mental health practitioner
    - might have one, several or many appointments
:::

## Queue What?

```{=html}
<br/>
```

These queues are **complicated**!

There are lots of moving parts, and lots of variation.

```{=html}
<br/>
```

:::: {.columns}

::: {.column width="30%" .fragment}
**Variation in when, and how frequently, people arrive**
:::

::: {.column width="5%" }

:::

::: {.column width="30%" .fragment}
**Variation in how long something takes to do**
:::

::: {.column width="5%" }

:::

::: {.column width="30%" .fragment}
**Variation in the pathways people take within a single system**
:::


::::

## Very Resourceful

Healthcare systems are full of **resources**

::: {.incremental}
- People üë©üèª‚Äç‚öïÔ∏è üë©üèø‚Äç‚öïÔ∏è üë®üèΩ‚Äç‚öïÔ∏è üë®üèΩ‚Äç‚öïÔ∏è üë©üèæ‚Äç‚öïÔ∏è
- Equipment üî¨ü©∫
- Rooms & cubicles üè•
- Beds üõåüèª üõåüèΩ üõåüèø üõåüèª üõåüèº üõåüèΩ üõåüèø
- Treatments üíâ ü©π üíä
- Vehicles üöë üöÅ üöó
:::

## So Demanding

There is **demand** from **entities** in the form of

::: {.incremental}
- People (in person) ü§í ü§¢ ü§ß
- People (on the phone) ‚òéÔ∏è
- Test Requests ü©ª üß™
:::

## Pathway Simulation: Why?

:::: {.columns}

:::{.column width="35%"}
![](resources/long_hospital_queue.jpeg){height=350px}
:::

:::{.column width="65%"}
Your emergency department is struggling.

You could try a range of different things...

::: {.incremental}
- increase the number of staff available to register, triage or treat
- increase the number of rooms or beds
:::

:::

::::

:::{.incremental}
- increase the rate at which tests can be processed
- add a new step in the process with a different kind of practitioner
- completely redesign of the pathway
:::

:::{.fragment .center}
**Which of these is the right answer?**
:::

## Pathway Simulation: Why?

Finding out which of these is a good option can be

- costly
- slow
- unsafe!


:::{.fragment}
And even if you do fix the original problem, there's a risk of knock-on effects elsewhere in the pathway that you didn't foresee.
:::

## Pathway Simulation: Why?

And even if you avoid that....

A system that is coping now might *not* cope

:::{.incremental}
- all the time
- if demand increases
- if resource temporarily decreases
:::


## It's All a Simulation

On HSMA, we teach a couple of different modelling techniques.

:::: {.columns}

::: {.column width="30%" .fragment}
### System Dynamics

High-level modelling technique that's often suited to uncovering fundamental issues with pathway or wider healthcare system design
:::

::: {.column width="5%" .fragment}
<div style="border-left:3px solid #fff;height:500px"></div>
:::

::: {.column width="30%" .fragment}
### Agent-Based Simulation

Individual-level modelling that is particularly interested in the impact of individual decisions on pathways and outcomes
:::

::: {.column width="5%" .fragment}
<div style="border-left:3px solid #fff;height:500px"></div>
:::

::: {.column width="30%" .fragment}
### Discrete Event Simulation

Individual-level modelling focussing on the flow of entities through a pathway and use of resources, allowing detailed investigation of capacity, queues and waits
:::

::::

::: {.fragment}

:::

## Discrete Event Simulation Nation

Today, I'm going to focus on Discrete Event Simulation (DES)<br/>(but you might want to look up more about the others too!)

## What is DES?
![](assets/2024-11-18-09-41-27.png)

##

![](assets/2024-11-18-10-12-15.png)

## Why DES?

DES fits our pathway modelling needs in healthcare really well.

There is inherently randomness in our systems!

- People don't turn up at a completely predictable rate

- In some systems, activities don't take a consistent length of time
    - length of stay can vary
    - the time for treatment in an emergency department can change
    - call durations can differ

- The number of contacts someone might have within a pathway may differ

And so on!


## Randomness

One of the best things about DES is **controlled randomness**.
<br/><br/>

:::: {.columns}

::: {.column width="45%" .fragment}
We can hold the random patterns consistent and **change resource levels or pathway design**
:::

::: {.column width="10%" }

:::

::: {.column width="45%" .fragment}
We can hold resources or pathway design consistent and **allow randomness**
:::

::::

<br/>

:::: {.columns .fragment}

::: {.column width="45%" }
This allows us to be sure the changes we're testing really are responsible for the differences
:::

::: {.column width="10%" }

:::

::: {.column width="45%" }
This allows us to test our system in multiple parallel universes, running it **tens** or even **hundreds** of times!
:::

::::


# Example DES Projects

## DES is popular!

On the HSMA we've had over 35 projects using DES in some capacity.

A third of the registered projects this year use DES

(as opposed to machine learning, ABS, system dynamics, natural language processing)

It's also frequently used in the PenCHORD team.

## Example 1: Bladder Cancer Pathway

In this [PenCHORD](https://arc-swp.nihr.ac.uk/research-and-implementation/research-teams/penchord/) project, a DES model of the bladder cancer pathway at Royal Cornwall Hospitals Trust (RCHT) exposed two key system bottlenecks.

1. A delay between patients being referred and receiving their Transurethral Resection of Bladder Tumour (TURBT)
1. A delay waiting for the nurse specialist to contact the patient to discuss their diagnosis and treatment options

The model was used to support an on-the-spot rewrite of the pathway, resulting in multi-week reductions to waiting times.
<br/><br/>
[{{< fa globe >}} Find Out More](https://arc-swp.nihr.ac.uk/research/projects/penchord-streamlining-the-bladder-cancer-pathway-at-rcht/)


## Example 2: Vaccination Clinic

This [HSMA](https://hsma-programme.github.io/hsma_site/) project looked at the design of a COVID-19 vaccination clinic, exploring

- queue lengths
- car park capacity
- times for each step of the vaccination process

The model identified potential issues with the original proposed plans, and was used to refine the plans to enable a safe but efficient delivery of the vaccinations in North Devon.
<br/><br/>
[{{< fa globe >}} Find Out More](https://hsma-programme.github.io/hsma_site/previous_projects/hsma_3/h3_generic_vaccination/)

## Example 3: Emergency Department Model

This [HSMA](https://hsma-programme.github.io/hsma_site/) project looked at ways to improve Urgent Treatment Care (UTC) performance. The Emergency Department (ED) team wanted to know

1. What further staff and resources would be required for any variations in patient attendance
2. How changes in the patient pathway would reduce bottlenecks (e.g what would be the impact of front-loading diagnostics?)

The DES model developed made it easy to understand the impact of changes and what would be most cost-effective. The ED was redesigned based on the model, which had identified a need for additional rooms.
<br/><br/>
[{{< fa globe >}} Find Out More](https://hsma-programme.github.io/hsma_site/previous_projects/hsma_3/h3_generic_vaccination/)


## Example 4: Mental Health Assessment Pathway Model

In this [PenCHORD](https://arc-swp.nihr.ac.uk/research-and-implementation/research-teams/penchord/) project, a simulation model of a mental health assessment pathway was created.

At the trust, which was piloting an approach that would allow patients to book their appointments themselves, the model was used to help

- predict the number of appointment slots required at each site
- show that allowing queue-sharing between smaller groups of sites would significantly reduce the wait times

[{{< fa globe >}} Find Out More](https://arc-swp.nihr.ac.uk/publications/scheduling-community-mental-health-assessment-in-devon/)


## Example 5: Children's Neurodiversity Assessment Pathway

This [HSMA](https://hsma-programme.github.io/hsma_site/) project created a model of a paediatric neurodevelopmental (ADHD + autism) pathway. Waits had increased to a 2 years on average.

The team wanted to understand

- where current bottlenecks in the process were
- what level of staffing would be needed to clear the existing backlog and maintain a steady state

The model showed that recruiting an extra lead clinician would not address the bottleneck - but an additional second assessor would.

[{{< fa globe >}} Find Out More](https://hsma-programme.github.io/hsma_site/previous_projects/hsma_4/h4_des_adhd_autism_pathway/)

## Other Projects

You can find details about all of our previous and current Discrete Event Simulation projects

[{{< fa globe >}} on the HSMA website](https://hsma-programme.github.io/hsma_site/previous_projects/projects_by_methods.html#discrete-event-simulation)

# Doing your Own DES Projects

## Drag & Drop

There ar various paid, closed-source drag-and-drop software tools for doing DES (but we won't talk about them here).

If you don't code, there is the free and open source (FOSS) tool [JaamSim](https://jaamsim.com/).

![](assets/2024-11-18-10-15-22.png)


## DES in R

::::{.columns}

:::{.column width=60%}
![](resources/simmer-hex-01.svg){height=500px}
:::

:::{.column width=40%}
<br/><br/>
R has the [simmer](https://r-simmer.org/) package.
:::

::::

## DES in Python

In Python, there are a range of packages for DES.

::::{.columns}

:::{.column width=40%}
![](assets/2024-11-18-10-19-04.png)
:::

:::{.column width=60%}
[Salabim](https://github.com/salabim/salabim) is quite popular.
:::

::::

::::{.columns}

:::{.column width=40%}
![](assets/2024-11-18-10-16-14.png)
:::

:::{.column width=60%}
I've also heard good things about [ciw](https://github.com/CiwPython/Ciw)
:::

::::

::::{.columns}

:::{.column width=40%}
![](assets/2024-11-18-10-17-01.png)
:::

:::{.column width=60%}
But HSMA has used and taught [simpy](https://simpy.readthedocs.io/en/latest/) for several years. It's mature, stable, reliable and flexible.
:::

::::


## HSMA Training on DES {.smaller}

[{{< fa globe >}} Module Link](https://hsma-programme.github.io/hsma_site/hsma_content/modules/current_module_details/2_des.html)

:::: {.columns}

::: {.column width="30%"}
### Intro to DES

- What DES is and where it may be useful
- The key terminology associated with DES (e.g. resources, entities, sinks)
- How to simplify a real-world pathway modelling problem into a conceptual model
:::

::: {.column width="5%"}

:::


::: {.column width="30%" .fragment}
### SimPy for DES

- The features of the SimPy package
- How to write simple simulations with SimPy
- Multi-step pathways
- Branching pathways and optional steps
:::

::: {.column width="5%"}

:::

::: {.column width="30%" .fragment}
### Advanced Simpy

- Warm-up Periods
- Priority-based Queuing
- Resource Unavailability
- Lognormal Distributions
- Reneging
- Balking
- Jockeying
:::

::::



## The Little Book of DES

:::: {.columns}

::: {.column width="50%"}
![](resources/des_cover_image.jpeg)
:::

::: {.column width="50%"}
This free eBook serves as a handy reference to doing DES with simpy and is packed with code snippets you can use and modify.
:::

::::

[{{< fa globe>}} &nbsp; Click here to view the Little Book of DES](https://hsma-programme.github.io/hsma6_des_book/)

## HSMA Training on Web App Interfaces for DES {.smaller}

::::{.columns}

:::{.column width=23%}
While creating these models and running a range of parameters yourself can be really powerful, getting the models into the hands of stakeholders can really enhance their adoption.
<br/><br/>
Frameworks like [Streamlit](https://streamlit.io/) can help you to quickly create interactive web app front-ends for your app.
:::

:::{.column width=3%}
:::

:::{.column width=74%}
![](assets/chrome_CdAZUpS295.gif)
:::

::::

## The HSMA Book of Streamlit


:::: {.columns}

::: {.column width="50%"}
![](resources/streamlit_cover_image.jpeg)
:::

::: {.column width="50%"}
This free eBook walks you through a range of Streamlit concepts.
<br/><br/>
It then goes on to providing a walk-through of how to create a simple front-end for any DES and deploying that on a free online hosting platform.
:::

::::

[{{< fa globe>}} &nbsp; Click here to view the HSMA Book of Streamlit](https://bergam0t.github.io/streamlit_book/)


## The DES Playground

This site was designed to help teach the key concepts of discrete event simulation to non-technical beginners.

::::{.columns}

:::{.column width="80%"}

![](assets/chrome_2RNEIsSXoP.gif)

:::

:::{.column width="20%"}

[{{< fa globe>}} &nbsp; Click here to visit!](https://hsma-programme.github.io/Teaching_DES_Concepts_Streamlit)
<br/><br/>

:::{.callout-warning}
Note that this won't work on Firefox.

It uses browser-based Python, so calculations can be slow on mobile devices!
:::

:::

::::

## Pathway Visualisation

As part of creating the DES playground, I put together the visualisation you saw in the previous slide.

It really resonated with people - so we wanted to make more use of it!

We know that one of the big limitations of simpy (and other FOSS code-based options) is not being able to produce quick and simple visualisations to show to stakeholders.


## The vidigi package

The [**vidigi**]() package is designed to be a flexible library for creating these animated visualisations for **any** simulation.

Under the hood, it makes use of plotly's animated scatterplots.

However, it adds a range of additional helper functions to

- process event logs into the format required
- lay out the animation
- add icons for resources and entities

## Moving from this...

```{python}
#| output: false
from examples.example_2_branching_multistep.ex_2_model_classes import Trial, g, event_position_df
from vidigi.animation import animate_activity_log
import pandas as pd


g.arrival_df = "examples/example_2_branching_multistep/ed_arrivals.csv"

my_trial = Trial()
result = my_trial.run_trial()
```

```{python}
fig = animate_activity_log(
        event_log=my_trial.all_event_logs[my_trial.all_event_logs['run']==1],
        event_position_df=event_position_df,
        scenario=g(),
        setup_mode=True,
        debug_mode=False,
        every_x_time_units=5,
        include_play_button=True,
        gap_between_entities=10,
        gap_between_rows=15,
        plotly_height=650,
        plotly_width=950,
        override_x_max=700,
        override_y_max=675,
        icon_and_text_size=12,
        wrap_queues_at=10,
        step_snapshot_max=50,
        limit_duration=g.sim_duration,
        time_display_units="dhm",
        display_stage_labels=False,
        custom_entity_icon_list=["üî¥"],
        custom_resource_icon=""
    )

fig.show()
```

## ... to this

```{python}
fig = animate_activity_log(
        event_log=my_trial.all_event_logs[my_trial.all_event_logs['run']==1],
        event_position_df=event_position_df,
        scenario=g(),
        setup_mode=False,
        debug_mode=False,
        every_x_time_units=5,
        include_play_button=True,
        gap_between_entities=10,
        gap_between_rows=15,
        plotly_height=650,
        plotly_width=950,
        override_x_max=700,
        override_y_max=675,
        icon_and_text_size=12,
        wrap_queues_at=10,
        step_snapshot_max=50,
        limit_duration=g.sim_duration,
        time_display_units="dhm",
        display_stage_labels=False,
        add_background_image="examples/example_2_branching_multistep/Full Model Background Image - Horizontal Layout.drawio.png",
    )

fig.show()
```

## Simulation Library

:::{.callout-warning}
This is an early-stage piece of work!
:::

To go along with vidigi, I'm working on collating and visualising models from across healthcare systems.

At present, there is

- A simple emergency department
- An orthopaedic surgery unit
- A simple community-based service with a single appointment
- A complex community-based service with varying numbers of appointments and a per-clinician caseload

[{{< fa brands github>}} &nbsp; Click here for the code repository](https://github.com/hsma-programme/simpy_visualisation/tree/main/examples)

[{{< fa globe>}} &nbsp; Click here to try them out](https://simpy-visualisation.streamlit.app/)


## Model Reproducibility

![](resources/stars.png)

Reproducibility and reusability of models is crucial.

I want to take a moment to highlight [STARS](https://github.com/pythonhealthdatascience)

This is a [UKRI-funded project](https://gtr.ukri.org/projects?ref=MR%2FZ503915%2F1) that is trying to ensure good reproducibility of healthcare simulation models.

They are also creating examples in Python and R, as well as creating open-source versions of closed-source models from published scientific papers.

## The STARS Framework {.smaller}

```{=html}
<br/>
```

:::: {.columns}

:::  {.column width="45%"}
#### Essential Components

- Open license
- Dependency management
- Model created using free and open-source software (FOSS)
- Minimum documentation
- Research artefact meta data (ORCID ID + citation information)
- Remote code repository
- Open science archive
:::

:::  {.column width="10%"}

:::

:::  {.column width="45%"}
#### Optional Components

- Enhanced documentation
- Documentation hosting
- Online coding environment
- Model interface
- Web app hosting
:::

::::


# End of Simulation

## Summary

- DES is an amazing option for tackling your pathway problems
- It's a great time to start modelling!
